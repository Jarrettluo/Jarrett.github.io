{"title":"Docker应用连接TDengine数据库的解决方案","uid":"e1808551f050f3a6ba3836556587dcae","slug":"Docker应用连接TDengine数据库的解决方案","date":"2021-11-03T11:20:11.000Z","updated":"2021-11-14T06:26:36.239Z","comments":true,"path":"api/articles/Docker应用连接TDengine数据库的解决方案.json","keywords":null,"cover":"http://h2.ioliu.cn/bing/NewtonPumpkins_ZH-CN2560195971_1920x1080.jpg","content":"<h2 id=\"1、工作环境\"><a href=\"#1、工作环境\" class=\"headerlink\" title=\"1、工作环境\"></a>1、工作环境</h2><p>开发工具：IDEA，安装插件docker</p>\n<p>TDengine Version：2.0.20.5</p>\n<p>taos jdbc Version: 2.0.22</p>\n<p>Springboot Version: 2.4.5</p>\n<p>Docker Version： 20.10.10</p>\n<hr>\n<h2 id=\"2、Dockerfile设置\"><a href=\"#2、Dockerfile设置\" class=\"headerlink\" title=\"2、Dockerfile设置\"></a>2、Dockerfile设置</h2><pre class=\"line-numbers language-dockerfile\" data-language=\"dockerfile\"><code class=\"language-dockerfile\">### 基础镜像\nFROM openjdk:8\n\n### 作者\nMAINTAINER luojiarui &lt;luojiarui2@163.com&gt;\n\n### 系统编码\nENV LANG&#x3D;C.UTF-8 LC_ALL&#x3D;C.UTF-8\n\n### 声明挂载点，容器内此路径会对应宿主机的某个文件夹\nVOLUME &#x2F;tmp\n\n### 应用构建成功以后jar文件被复制到镜像内，名字也改为app.jar\nADD target&#x2F;service-app-1.0-SNAPSHOT.jar app.jar\n\n### 启动容器时的进程\nENTRYPOINT [&quot;java&quot;， &quot;-jar&quot;, &quot;&#x2F;app.jar&quot;]\n\n### 暴露的端口\nEXPOSE 8099\n    <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n<p>在IDEA中编写一个Dorckerfile，文件的位置和springboot项目的根目录一致。</p>\n<p>使用远程的Ubuntu服务器的docker进行镜像打包和部署。</p>\n<p>再检查一遍项目的配置文件，这里需要设置jdbc的连接配置：</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token comment\">### 设置JDBC的连接地址，必须加上taos的账号密码，这里使用的是TDengine的默认密码</span>\n<span class=\"token key atrule\">taosJdbc</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>TAOS<span class=\"token punctuation\">:</span>//node1<span class=\"token punctuation\">:</span>6030//alpha_db？user=root<span class=\"token important\">&amp;password=taosdata</span>\n\n<span class=\"token comment\">### 使用Restful连接taos的配置也记录下来</span>\n<span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">taos-path</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//node1<span class=\"token punctuation\">:</span>6041/rest/sql\n    <span class=\"token key atrule\">table</span><span class=\"token punctuation\">:</span> alpha_db.can_super<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n<p>从项目的配置文件中，可以看到FQDN设置的是node1。</p>\n<p>node1是TDengine机所在机器的地址，其真实ip地址为： 129.122.12.12。</p>\n<p>特别要注意这里的修改，否则会出现问题。</p>\n<hr>\n<h2 id=\"3、创建容器\"><a href=\"#3、创建容器\" class=\"headerlink\" title=\"3、创建容器\"></a>3、创建容器</h2><p>根据镜像文件service-app:v1创建容器的命令如下。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run \n    -d ## 后台运行\n    -name service-app ## 容器命令\n    -p 8099:8099 ## 端口映射，&lt;主机端口: 容器端口&gt;\n    -v &#x2F;usr&#x2F;local&#x2F;taos&#x2F;driver&#x2F;libtaos.so.2.0.20.5:&#x2F;usr&#x2F;lib&#x2F;libtaos.so ## 指定容器里taos的数据库客户端\n    -v &#x2F;usr&#x2F;share&#x2F;zoneinfo:&#x2F;usr&#x2F;share&#x2F;zoneinfo ## 数据卷映射\n    -e TZ&#x3D;AsiaShanghai ## 时区\n    --add-host&#x3D;node1:10.30.5.55 ## 增加DNS解析\n    service-app:v1 ## 容器名<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<hr>\n<h2 id=\"4、容器内缺少驱动\"><a href=\"#4、容器内缺少驱动\" class=\"headerlink\" title=\"4、容器内缺少驱动\"></a>4、容器内缺少驱动</h2><h4 id=\"问题1-java使用JDBC建立简介，在windows系统上可以正常运行，打包放到docker容器中运行时，出现如下异常：\"><a href=\"#问题1-java使用JDBC建立简介，在windows系统上可以正常运行，打包放到docker容器中运行时，出现如下异常：\" class=\"headerlink\" title=\"问题1: java使用JDBC建立简介，在windows系统上可以正常运行，打包放到docker容器中运行时，出现如下异常：\"></a>问题1: java使用JDBC建立简介，在windows系统上可以正常运行，打包放到docker容器中运行时，出现如下异常：</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">$ Caused by: Java.lang.NoClassDefFonderError： Could not initialize calss com.taosdata.jdbc.TSDBJNIConnecter\n....<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>通过查找前人的方案，通过指定taos驱动和时区，解决该问题。</p>\n<p><a href=\"https://github.com/taosdata/TDengine/issues/4238\">https://github.com/taosdata/TDengine/issues/4238</a> “java.lang.NoClassDefFoundError: Could not initialize class com.taosdata.jdbc.TSDBJNIConnector #4238”</p>\n<h4 id=\"问题2：使用的基础镜像Aline不支持\"><a href=\"#问题2：使用的基础镜像Aline不支持\" class=\"headerlink\" title=\"问题2：使用的基础镜像Aline不支持\"></a>问题2：使用的基础镜像Aline不支持</h4><pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\">$ &#x2F;user&#x2F;lib&#x2F;libtaos.so: Error loading shared libary ld-linux-x86-64.so.2: No such file or directory (needed by &#x2F;usr&#x2F;lib&#x2F;libtaos.so)\n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>在驱动已经映射的基础上，依然缺少某些文件，那么就找一下为什么缺少的原因。</p>\n<p>进入docker以后，查找一下。</p>\n<pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\">### 进入docker\nroot@xxxx: docker exec -it service-app sh\n\n### 查找\n&#x2F;# ldd &#x2F;usr&#x2F;lib&#x2F;libtaos.so\n    ldd(0x7fefebee2000)\n    libpthread.so.0 &#x3D;&gt; ldd(0x7fefebee2000)\n    libm.so.6 &#x3D;&gt; ldd(0x7fefebee2000)\n    librt.so.1 &#x3D;&gt; ldd(0x7fefebee2000)\n    libc.so.6 &#x3D;&gt; ldd(0x7fefebee2000)\nError loading shared libaray ld-linux-x86-64.so.2: No such file or directory (need by &#x2F;usr&#x2F;lib&#x2F;libtaos.so)\nError relocating &#x2F;usr&#x2F;lib&#x2F;libtaos.so: _pthread_register_cancel: sysbol not found\n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>可以看出这里缺少某些东西，判断是由于我们使用了精简版的JDK，那么我们就将原来的alpine版本的JDK给更换掉。</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token comment\">### 原来的基础镜像</span>\nFROM openjdk<span class=\"token punctuation\">:</span>8<span class=\"token punctuation\">-</span>alpine\n\n<span class=\"token comment\">### 更换为</span>\nFROM openjdk<span class=\"token punctuation\">:</span><span class=\"token number\">8</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>通过更换基础镜像，虽然镜像文件从161MB增加到了320MB，但是该问题解决。</p>\n<hr>\n<h2 id=\"5、容器无法连接TDengine\"><a href=\"#5、容器无法连接TDengine\" class=\"headerlink\" title=\"5、容器无法连接TDengine\"></a>5、容器无法连接TDengine</h2><p>无法连接TDengine： TDengine ERROR （80000015）： Unable to resolve FQDN.</p>\n<p>JNI CONNECTION is NULL</p>\n<p>解决该问题的办法即是注意JDBC连接的时候不能使用IP地址，然后在运行的容器的时候增加以下的命令。</p>\n<pre><code>--add-host=node1:10.30.5.55 ## 增加DNS解析\n</code></pre>\n<hr>\n<h2 id=\"6、总结\"><a href=\"#6、总结\" class=\"headerlink\" title=\"6、总结\"></a>6、总结</h2><p>目前TDengine暂时没有看到官方指导案例，在使用docker连接TDengine的时候注意以上细节，一般不会有任何问题。<br>另外还要注意设置docker的时区问题，否则在使用时间范围查询数据库时会出现时区偏差。</p>\n<p>特别感谢涛思数据的董工提供的技术支持。</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>如果您觉得上面的内容对您有帮助欢迎点赞、评论、转发！<br>更多内容请查阅作者博客：<a href=\"https://jiaruiblog.com/\">https://jiaruiblog.com</a><br>或者<code>star</code>作者github: <a href=\"https://github.com/Jarrettluo?tab=repositories\">https://github.com/Jarrettluo?tab=repositories</a></p></blockquote>\n","feature":true,"text":"1、工作环境开发工具：IDEA，安装插件docker TDengine Version：2.0.20.5 taos jdbc Version: 2.0.22 Springboot Version: 2.4.5 Docker Version： 20.10.10 2、Dockerfi...","link":"","photos":[],"count_time":{"symbolsCount":"3.2k","symbolsTime":"3 mins."},"categories":[{"name":"后端开发","slug":"后端开发","count":1,"path":"api/categories/后端开发.json"}],"tags":[{"name":"docker","slug":"docker","count":1,"path":"api/tags/docker.json"},{"name":"TDengine","slug":"TDengine","count":1,"path":"api/tags/TDengine.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1%E3%80%81%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83\"><span class=\"toc-text\">1、工作环境</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2%E3%80%81Dockerfile%E8%AE%BE%E7%BD%AE\"><span class=\"toc-text\">2、Dockerfile设置</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3%E3%80%81%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8\"><span class=\"toc-text\">3、创建容器</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4%E3%80%81%E5%AE%B9%E5%99%A8%E5%86%85%E7%BC%BA%E5%B0%91%E9%A9%B1%E5%8A%A8\"><span class=\"toc-text\">4、容器内缺少驱动</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E9%97%AE%E9%A2%981-java%E4%BD%BF%E7%94%A8JDBC%E5%BB%BA%E7%AB%8B%E7%AE%80%E4%BB%8B%EF%BC%8C%E5%9C%A8windows%E7%B3%BB%E7%BB%9F%E4%B8%8A%E5%8F%AF%E4%BB%A5%E6%AD%A3%E5%B8%B8%E8%BF%90%E8%A1%8C%EF%BC%8C%E6%89%93%E5%8C%85%E6%94%BE%E5%88%B0docker%E5%AE%B9%E5%99%A8%E4%B8%AD%E8%BF%90%E8%A1%8C%E6%97%B6%EF%BC%8C%E5%87%BA%E7%8E%B0%E5%A6%82%E4%B8%8B%E5%BC%82%E5%B8%B8%EF%BC%9A\"><span class=\"toc-text\">问题1: java使用JDBC建立简介，在windows系统上可以正常运行，打包放到docker容器中运行时，出现如下异常：</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E9%97%AE%E9%A2%982%EF%BC%9A%E4%BD%BF%E7%94%A8%E7%9A%84%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8FAline%E4%B8%8D%E6%94%AF%E6%8C%81\"><span class=\"toc-text\">问题2：使用的基础镜像Aline不支持</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#5%E3%80%81%E5%AE%B9%E5%99%A8%E6%97%A0%E6%B3%95%E8%BF%9E%E6%8E%A5TDengine\"><span class=\"toc-text\">5、容器无法连接TDengine</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#6%E3%80%81%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">6、总结</span></a></li></ol>","author":{"name":"JIARUI's BLOG","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17515212?s=400&u=3dc2bbf2e6239369be5c37d357699a46d94404c9&v=4","link":"/","description":"数据应用大师Master <br /> <b>谋时而动 顺势而为</b>","socials":{"github":"https://github.com/Jarrettluo","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/luo-jia-rui","csdn":"https://blog.csdn.net/JarrettLuo","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"mm-wiki的packets.go:36: unexpected EOF解决","uid":"62d76556d121d2872e8a9782563ea5e2","slug":"mm-wiki的packets-go-36-unexpected-EOF解决","date":"2021-11-14T06:10:32.000Z","updated":"2021-11-14T06:24:50.805Z","comments":true,"path":"api/articles/mm-wiki的packets-go-36-unexpected-EOF解决.json","keywords":null,"cover":"http://h2.ioliu.cn/bing/YorkMinster_ZH-CN3129176050_1920x1080.jpg","text":"背景MM-Wiki 是一个轻量级的企业知识分享与团队协同软件，可用于快速构建企业 Wiki 和团队知识分享平台。部署方便，使用简单，帮助团队构建一个信息共享、文档管理的协作环境。https://github.com/phachon/mm-wiki 某天服务器磁盘满了以后，出现已经...","link":"","photos":[],"count_time":{"symbolsCount":"1.3k","symbolsTime":"1 mins."},"categories":[{"name":"debug","slug":"debug","count":2,"path":"api/categories/debug.json"}],"tags":[{"name":"go","slug":"go","count":1,"path":"api/tags/go.json"}],"author":{"name":"JIARUI's BLOG","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17515212?s=400&u=3dc2bbf2e6239369be5c37d357699a46d94404c9&v=4","link":"/","description":"数据应用大师Master <br /> <b>谋时而动 顺势而为</b>","socials":{"github":"https://github.com/Jarrettluo","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/luo-jia-rui","csdn":"https://blog.csdn.net/JarrettLuo","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"Javascript 对象数组取差集和交集的方法","uid":"96d44811f44a8268573d11efdeedbe54","slug":"Javascript-对象数组取差集和交集的方法","date":"2021-10-18T07:12:09.000Z","updated":"2021-11-14T06:25:48.538Z","comments":true,"path":"api/articles/Javascript-对象数组取差集和交集的方法.json","keywords":null,"cover":"http://h2.ioliu.cn/bing/MistyForest_ZH-CN3024731044_1920x1080.jpg","text":"前言对象数组常会进行取交集或者差集的操作。假设有对象数组A和对象数组B，常规方法是比较B对象数组与A对象数组的差异，进而找到其差集或者交集。但是现在面临的问题是数组A 和数组B中的对象可能不完全一样的情况，可采用以下方法解决该问题。 对象数组的定义我们把对象数组A定义为长数组，其...","link":"","photos":[],"count_time":{"symbolsCount":"6.9k","symbolsTime":"6 mins."},"categories":[],"tags":[{"name":"Javascript","slug":"Javascript","count":2,"path":"api/tags/Javascript.json"}],"author":{"name":"JIARUI's BLOG","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17515212?s=400&u=3dc2bbf2e6239369be5c37d357699a46d94404c9&v=4","link":"/","description":"数据应用大师Master <br /> <b>谋时而动 顺势而为</b>","socials":{"github":"https://github.com/Jarrettluo","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/luo-jia-rui","csdn":"https://blog.csdn.net/JarrettLuo","juejin":"","customs":{}}}}}